---
title: Deploy a Virtual Cluster
sidebar_label: 1. Deploy vCluster
description: Learn how deploy vCluster.
---

import Tabs from '@theme/Tabs'
import TabItem from '@theme/TabItem'

import InstallCLIFragment from '@site/docs/_fragments/install/cli.mdx'

## Learning objectives

In this guide, you learn the following:

@TODO flesh out this list after other pages done 

1. How to deploy a virtual cluster.
1. [How to use your virtual cluster](/get-started/02-use-cluster.mdx).
1. [How to configure your cluster](/get-started/03-configure-cluster.mdx).
1. [How to uninstall vCluster](/get-started/04-cleanup.mdx).

You can join the [Loft Users Slack](https://slack.loft.sh/) to ask questions in the #vcluster channel.

## Key concepts and components

- **vCluster**: the product, which runs in a single Pod.
- `vcluster`: the CLI.
- **Host**: The Kubernetes cluster onto which you deploy vCluster. 
- **Virtual cluster**: the [virtual cluster](/architecture/README.mdx) that vCluster creates.

vCluster components:

- **Control plane**: The [control plane](/architecture/control-plane.mdx) contains a Kubernetes API server, a controller manager, and a data store mount. 
- **Nodes**:
- **Pods**:
- **Control plane**:

## Before you begin

- You have installed [kubectl](https://kubernetes.io/docs/tasks/tools/#kubectl) and have access to a Kubernetes cluster to use as the host cluster.



## Install the vCluster CLI

@TODO I'm assuming users should install the CLI even if they are not using the CLI to deploy clusters.

Use one of the following commands to download and install the vCluster CLI binary from GitHub:

<InstallCLIFragment/>


## Deploy a virtual cluster

Deploy a vCluster instance to the 'my-cluster' namespace. Installation creates the namespace if it does not yet exist. When you create namespaces within your virtual cluster, those resources are encapsulated within the vCluster namespace. 

<Tabs
  groupId="get-started"
  defaultValue="cli"
  values={[
	{ label: "CLI", value: "cli" },
    { label: 'Helm', value: 'helm', },
    { label: 'kubectl', value: 'kubectl', },
    { label: 'Terraform', value: 'terraform', },
    { label: 'Argo CD', value: 'argo', },
    { label: 'Cluster API', value: 'cluster-api', },
  ]
}>
<TabItem value="cli">

:::info Default distro
[K3s](https://k3s.io/) is the default Kubernetes distribution.
:::

to create a new vCluster instance in namespace `vcluster-my-vcluster`, execute:

```bash
vcluster create my-cluster`
```

When the installation finishes, you should see output similar to:

```bash
done Switched active kube context to vcluster_my-cluster
- Use `vcluster disconnect` to return to your previous kube context
```

`vcluster create` has config options for specific cases:

* Use `--expose` to create a vCluster in a remote cluster with an externally accessible LoadBalancer. 

  `vcluster create my-vcluster --expose`

* Use `-f` to use an additional Helm `values.yaml` with extra chart options to deploy vCluster.

  `vcluster create my-vcluster -f values.yaml`

* Use `--distro` to specify either k0s or vanilla k8s as a backing virtual cluster.

  `vcluster create my-vcluster --distro k8s`

* Use `--isolate` to create an isolated environment for the vCluster workloads
  
  `vcluster create my-vcluster --isolate`

</TabItem>
<TabItem value="helm">

@TODO Helm install instructions still correct?

You want vCluster to use K3s, so create a file called `vcluster.yaml` with the following contents:

```yaml
vcluster:
  image: rancher/k3s:v1.29.1+k3s2    # Choose K3s version
```

Then, install the Helm chart, specifying `vcluster.yaml` for chart values:

```bash
helm upgrade --install my-vcluster vcluster \
  --values vcluster.yaml \
  --repo https://charts.loft.sh \
  --namespace vcluster-my-vcluster \
  --repository-config=''
```

</TabItem>
<TabItem value="kubectl">

This installs vCluster with default values.

```bash
kubectl create namespace vcluster-my-vcluster
helm template my-vcluster vcluster --repo https://charts.loft.sh -n vcluster-my-vcluster | kubectl apply -f -
```

</TabItem>
<TabItem value="terraform">

@TODO Terraform deploy instructions

</TabItem>
<TabItem value="argo">

@TODO Argo CD deploy instructions

</TabItem>
<TabItem value="cluster-api">

@TODO Cluster API deploy instructions

</TabItem>
</Tabs>

:::note Contexts
In this guide, vCluster installation creates a new context that starts with "vcluster_my-cluster" and updates your `kubeconfig` file to point to that context. 

* Execute `vcluster connect my-cluster` to connect to your vCluster context.
* Execute `vcluster disconnect` to switch back to your default (host) context.

:::

## Retrieve the virtual cluster kubeconfig

There might be cases where connecting to a vCluster with the CLI is not feasible or the CLI cannot be installed. For such cases, you can retrieve the vCluster kubeconfig from a secret that is created automatically in the vCluster namespace.

The secret is prefixed with `vc-` and ends with the vCluster name, so a vCluster called `my-vcluster` in namespace `test` would create a secret called `vc-my-vcluster` in the namespace `test`. 

<Tabs
  groupId="get-started"
  defaultValue="cli"
  values={[
	{ label: "CLI", value: "cli" },
    { label: 'Helm', value: 'helm', },
    { label: 'kubectl', value: 'kubectl', },
    { label: 'Terraform', value: 'terraform', },
    { label: 'Argo CD', value: 'argo', },
    { label: 'Cluster API', value: 'cluster-api', },
  ]
}>
<TabItem value="cli">

@TODO CLI retrieve virtual cluster kubeconfig

</TabItem>
<TabItem value="helm">

@TODO Helm retrieve kubeconfig

</TabItem>
<TabItem value="kubectl">

```bash
kubectl get secret vc-my-vcluster -n test --template={{.data.config}} | base64 -D
```

</TabItem>
<TabItem value="terraform">

@TODO Terraform retrieve kubeconfig

</TabItem>
<TabItem value="argo">

@TODO Argo CD retrieve kubeconfig

</TabItem>
<TabItem value="cluster-api">

@TODO Cluster API retrieve kubeconfig

</TabItem>
</Tabs>

The secret holds a kubeconfig in this format:

```yaml
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0t...
    server: https://localhost:8443
  name: local
contexts:
- context:
    cluster: local
    namespace: default
    user: user
  name: Default
current-context: Default
kind: Config
users:
- name: user
  user:
    client-certificate-data: LS0tLS...
    client-key-data: LS0tLS...
```


## Connect to your virtual cluster

You can use the CLI to quickly connect to your virtual cluster. Execute:

```bash
vcluster connect my-cluster
```

Output is similar to:

```bash
done Switched active kube context to vcluster_my-cluster
- Use `vcluster disconnect` to return to your previous kube context
```

You can retrieve a list of vCluster instance names by running `vcluster list`.

By default, the vCluster CLI connects to the virtual cluster either directly (on local Kubernetes distributions) or via port-forwarding for remote clusters. If you want to use vCluster on remote clusters without port-forwarding, you can take a look at other supported exposing methods.

## Run kubectl commands

A virtual cluster behaves the same way as a regular Kubernetes cluster. That means you can run any `kubectl` command. Since you are admin of this vCluster, you can even run commands like these:

```bash
kubectl get namespace
kubectl get pods -n kube-system
```

